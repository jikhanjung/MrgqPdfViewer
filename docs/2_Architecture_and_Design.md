# 2. 아키텍처 및 설계

## 2.1 전체 아키텍처 개요

MrgqPdfViewer는 Android TV 환경에 최적화된 PDF 악보 뷰어 애플리케이션으로, 모듈화된 컴포넌트와 명확한 책임 분리를 통해 유지보수성과 확장성을 확보하고 있습니다. 주요 컴포넌트들은 UI, 상태 관리, 비즈니스 로직을 담당하며 유기적으로 연결됩니다.

### 핵심 컴포넌트:

*   **`MainActivity.kt`**: 앱의 진입점입니다. PDF 파일 목록을 표시하고, 파일 관리(정렬, 삭제) 및 합주 모드 설정을 시작하는 사용자 인터랙션을 처리합니다.
*   **`PdfViewerActivity.kt`**: PDF 파일을 표시하는 화면입니다. `PdfRenderer`를 관리하고, 페이지 탐색을 처리하며, 합주 세션 중 지휘자 및 연주자 역할에 대한 로직을 구현합니다. (대규모 리팩토링 예정)
*   **`GlobalCollaborationManager.kt`**: 합주 서버 및 클라이언트의 생명주기를 관리하는 싱글톤 클래스입니다. 단일 액티비티와 독립적으로 애플리케이션 전반의 합주 모드 상태를 유지합니다.
*   **`CollaborationServerManager.kt`**: 지휘자 역할을 위한 WebSocket 서버를 관리합니다. 클라이언트 연결, 연결 해제 및 메시지 브로드캐스팅을 처리합니다.
*   **`CollaborationClientManager.kt`**: 연주자 역할을 위한 WebSocket 클라이언트를 관리합니다. 지휘자 서버에 연결하고 수신 메시지를 처리합니다.
*   **`ConductorDiscovery.kt`**: 자동 발견 기능을 위한 UDP 브로드캐스트 및 수신 로직을 구현합니다.
*   **`PageCache.kt`**: PDF 페이지의 `Bitmap` 표현을 미리 렌더링하고 저장하여 페이지 전환 속도를 높이는 캐싱 메커니즘입니다.
*   **`SimpleWebSocketServer.kt`**: 기본적인 WebSocket 서버 구현입니다.
*   **`FileServerManager.kt`**: 합주 중 파일 공유를 위한 HTTP 서버를 관리합니다.

### 데이터 흐름:

*   **UI 계층:** `MainActivity`와 `PdfViewerActivity`는 UI 렌더링 및 사용자 입력 처리를 담당합니다.
*   **상태 관리:** `GlobalCollaborationManager`는 합주 기능의 중앙 상태 관리자 역할을 합니다.
*   **비즈니스 로직:** 합주 로직은 `CollaborationServerManager`와 `CollaborationClientManager`로 분리되어 있습니다. PDF 렌더링 로직은 `PdfViewerActivity`에 있습니다.
*   **데이터 영속성:** `MusicRepository`와 `database` 패키지는 Room 데이터베이스와의 모든 상호작용을 처리합니다.

## 2.2 UI/UX 설계 원칙

MrgqPdfViewer는 Android TV 환경에 최적화된 사용자 경험을 제공하기 위해 다음 원칙을 따릅니다.

*   **리모컨 최적화:** 모든 UI 요소는 D-패드(DPAD) 및 엔터(ENTER) 키로 완벽하게 탐색 가능해야 합니다. 최소 터치 영역(72dp)을 준수하여 리모컨 조작의 용이성을 확보합니다.
*   **직관적인 탐색:** 복잡한 스크롤 UI 대신 카테고리별 메뉴 구조를 사용하여 사용자가 원하는 설정이나 기능을 쉽게 찾을 수 있도록 합니다.
*   **시각적 명확성:** 이모지 아이콘과 명확한 텍스트를 사용하여 기능의 목적을 즉시 식별할 수 있도록 합니다.
*   **몰입형 뷰어:** PDF 뷰어는 고해상도 렌더링과 최소한의 UI 요소로 악보 보기에 집중할 수 있는 환경을 제공합니다.
*   **피드백:** 사용자 동작에 대한 즉각적인 시각적/텍스트 피드백을 제공하여 현재 상태를 명확히 인지할 수 있도록 합니다.

## 2.3 데이터베이스 설계

Room 데이터베이스는 PDF 파일 메타데이터 및 사용자 선호도를 영구적으로 저장하는 데 사용됩니다.

### 주요 엔티티:

*   **`PdfFile`**: PDF 파일 자체의 메타데이터를 저장합니다.
    *   `id` (PRIMARY KEY): 파일 해시 기반 고유 식별자
    *   `filename`, `filePath`: 파일 정보
    *   `totalPages`: 총 페이지 수
    *   `orientation`: 페이지 방향 (PORTRAIT/LANDSCAPE)
    *   `width`, `height`: PDF 원본 크기
    *   `composer`, `title`, `genre` 등 음악 메타데이터 필드 (향후 확장 예정)
*   **`UserPreference`**: 파일별 사용자 설정을 저장합니다.
    *   `pdfFileId` (PRIMARY KEY): `PdfFile` 엔티티 참조
    *   `displayMode`: 표시 모드 설정 (AUTO, SINGLE, DOUBLE)
    *   `lastPageNumber`: 마지막으로 읽은 페이지 번호
    *   `bookmarkedPages`: 북마크된 페이지 목록 (향후 확장 예정)
    *   `topClippingPercent`: 위쪽 클리핑 비율 (0.0 ~ 1.0)
    *   `bottomClippingPercent`: 아래쪽 클리핑 비율 (0.0 ~ 1.0)
    *   `centerPadding`: 가운데 여백 비율 (0.0 ~ 0.15)

### 데이터 접근:
`MusicRepository`는 데이터 접근 계층을 추상화하여 데이터베이스와의 모든 상호작용을 관리합니다.

## 2.4 주요 리팩토링 계획

`PdfViewerActivity.kt`는 현재 너무 많은 책임을 가지고 있어 유지보수 및 테스트가 어렵습니다. 이를 해결하기 위해 대규모 리팩토링을 계획하고 있습니다.

### `PdfViewerActivity` 리팩토링 목표:

*   **단일 책임 원칙 (SRP) 준수:** 각 클래스가 하나의 명확한 책임만 가지도록 분리합니다.
*   **모듈화:** 기능을 독립적인 컴포넌트로 분리하여 코드의 가독성과 재사용성을 높입니다.
*   **테스트 용이성:** UI와 비즈니스 로직을 분리하여 단위 테스트를 용이하게 합니다.

### 제안된 새로운 컴포넌트:

1.  **`PdfPageManager`**: PDF 렌더링, 페이지 캐싱, 디스플레이 관련 모든 로직을 담당합니다.
2.  **`ViewerInputHandler`**: 모든 사용자 입력(키 이벤트)을 처리하고, 페이지 탐색 및 UI 상호작용을 관리합니다.
3.  **`ViewerFileManager`**: PDF 파일 로딩 및 파일 간 전환 로직을 담당합니다.
4.  **`ViewerCollaborationManager`**: 뷰어 화면 내에서 발생하는 합주 관련 로직(원격 페이지/파일 변경 처리, 지휘자 브로드캐스팅)을 담당합니다.

`PdfViewerActivity`는 이들 매니저 클래스들을 초기화하고, 이들 간의 조정을 담당하는 **코디네이터** 역할로 축소될 것입니다.

## 2.5 보안 아키텍처

MrgqPdfViewer의 통신 보안은 두 가지 주요 시나리오에 맞춰 설계되었습니다.

### 1. 합주 모드 (앱 간 통신): WSS (WebSocket Secure) 구현 시도 및 롤백

*   **목표:** 로컬 네트워크 상에서 지휘자 앱과 연주자 앱 간의 안전한 암호화 통신을 보장합니다.
*   **시도 내용:**
    *   앱 내부에 자체 서명 인증서를 내장하고, 이를 사용하여 WSS 서버를 구동하려고 시도했습니다.
    *   연주자 앱은 `network_security_config.xml`을 통해 내장된 공개키를 신뢰하도록 구성하여 중간자 공격(MITM)을 방어하는 인증서 피닝을 구현하고자 했습니다.
*   **현재 상태 (롤백):**
    *   테스트 과정에서 Android 플랫폼과 `keytool`로 생성한 인증서 간의 호환성 문제로 SSL 연결에 실패했습니다.
    *   안정적인 기능 제공을 위해, 현재는 암호화되지 않은 일반 WebSocket(WS)으로 롤백된 상태입니다. WSS 구현은 향후 기술 과제로 남아있습니다.

### 2. 웹 브라우저를 이용한 파일 업로드: HTTP (현재)

*   **목표:** 사용자가 PC 브라우저에서 앱이 띄운 웹서버에 접속하여 PDF 파일을 업로드할 수 있도록 합니다.
*   **현재 구현:** 현재는 **HTTP** 프로토콜을 사용하여 파일을 업로드합니다.
*   **고려 사항:**
    *   self-signed 인증서를 사용하여 HTTPS 서버를 구동할 경우, 브라우저에서 보안 경고가 발생하여 사용자 경험을 저해하고, 사용자가 무비판적으로 경고를 무시하는 습관을 들일 수 있습니다.
    *   따라서 현재는 사용자 편의성을 위해 HTTP를 사용하고 있습니다.
*   **향후 계획:** 장기적으로는 **공인 인증서 기반의 외부 서버(`sync.scoremate.ai` 등)**를 통해 파일을 업로드하고 앱이 해당 서버와 HTTPS로 동기화하는 방안을 고려하고 있습니다. 이는 보안성과 사용자 경험을 동시에 확보할 수 있는 최적의 대안입니다.

이러한 아키텍처 및 설계 원칙은 MrgqPdfViewer가 안정적이고, 안전하며, 확장 가능한 애플리케이션으로 발전하는 데 기여할 것입니다.
