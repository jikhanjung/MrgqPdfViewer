# 합주 모드 통신 프로토콜

이 문서는 MrgqPdfViewer 앱의 합주 모드에서 지휘자(서버)와 연주자(클라이언트) 기기 간에 교환되는 메시지 프로토콜을 정의합니다. 통신은 WebSocket(WSS)을 통해 이루어지며, 메시지 형식은 JSON입니다.

## 1. 공통 메시지 구조

모든 메시지는 `action` 필드를 포함하는 JSON 객체입니다. `action` 필드는 메시지의 종류를 나타냅니다.

```json
{
  "action": "<메시지_종류>",
  "timestamp": <유닉스_타임스탬프_밀리초>,
  // ... 기타 필드
}
```

## 2. 지휘자 -> 연주자 메시지

### 2.1 페이지 변경 (`page_change`)

지휘자가 PDF 뷰어에서 페이지를 변경할 때 연주자에게 현재 페이지 정보를 브로드캐스트합니다.

*   **목적:** 연주자 기기의 PDF 뷰어 페이지를 지휘자와 동기화합니다.
*   **발신자:** 지휘자 (서버)
*   **수신자:** 모든 연결된 연주자 (클라이언트)

```json
{
  "action": "page_change",
  "page": <정수_페이지_번호>, // 1부터 시작하는 페이지 번호
  "file": "<문자열_파일_이름>", // 현재 열려있는 PDF 파일 이름
  "timestamp": <유닉스_타임스탬프_밀리초>
}
```

### 2.2 파일 변경 (`file_change`)

지휘자가 PDF 파일을 변경할 때 연주자에게 새로운 파일 정보를 브로드캐스트합니다. 연주자에게 해당 파일이 없을 경우 다운로드를 제안할 수 있습니다.

*   **목적:** 연주자 기기의 PDF 파일을 지휘자와 동기화합니다.
*   **발신자:** 지휘자 (서버)
*   **수신자:** 모든 연결된 연주자 (클라이언트)

```json
{
  "action": "file_change",
  "file": "<문자열_파일_이름>", // 변경된 PDF 파일 이름
  "page": <정수_페이지_번호>, // 변경된 파일에서 시작할 페이지 번호 (1부터 시작)
  "timestamp": <유닉스_타임스탬프_밀리초>,
  "file_server_url": "<문자열_파일_서버_URL>" // 연주자가 파일을 다운로드할 수 있는 HTTP 서버 URL (선택 사항)
}
```

### 2.3 목록으로 돌아가기 (`back_to_list`)

지휘자가 PDF 뷰어에서 메인 파일 목록 화면으로 돌아갈 때 연주자에게 이를 알립니다.

*   **목적:** 연주자 기기도 메인 파일 목록 화면으로 돌아가도록 지시합니다.
*   **발신자:** 지휘자 (서버)
*   **수신자:** 모든 연결된 연주자 (클라이언트)

```json
{
  "action": "back_to_list",
  "timestamp": <유닉스_타임스탬프_밀리초>
}
```

### 2.4 연결 응답 (`connect_response`)

연주자가 지휘자에게 연결을 시도했을 때, 지휘자 서버가 연결 성공을 알리는 응답 메시지입니다.

*   **목적:** 연주자에게 연결 성공 및 서버 정보(선택 사항)를 알립니다.
*   **발신자:** 지휘자 (서버)
*   **수신자:** 특정 연주자 (클라이언트)

```json
{
  "action": "connect_response",
  "status": "success", // 항상 "success"
  "master_id": "master_device", // 지휘자 기기의 고유 ID (현재는 고정값)
  "client_id": "<문자열_클라이언트_ID>", // 연결된 연주자 기기의 고유 ID
  "server_version": "<문자열_서버_버전>", // 지휘자 앱 버전 (선택 사항)
  "timestamp": <유닉스_타임스탬프_밀리초>
}
```

## 3. 연주자 -> 지휘자 메시지

### 3.1 클라이언트 연결 (`client_connect`)

연주자가 지휘자에게 WebSocket 연결을 수립한 후, 자신의 기기 정보를 지휘자에게 알립니다.

*   **목적:** 지휘자가 연결된 연주자 기기의 정보를 식별할 수 있도록 합니다.
*   **발신자:** 연주자 (클라이언트)
*   **수신자:** 지휘자 (서버)

```json
{
  "action": "client_connect",
  "device_id": "<문자열_기기_ID>", // 연주자 기기의 고유 ID
  "device_name": "<문자열_기기_이름>", // 연주자 기기의 사용자 친화적인 이름 (예: "Android TV Device")
  "app_version": "<문자열_앱_버전>", // 연주자 앱 버전
  "timestamp": <유닉스_타임스탬프_밀리초>
}
```

### 3.2 하트비트 (`heartbeat`)

연주자가 연결이 활성 상태임을 지휘자에게 주기적으로 알립니다.

*   **목적:** 연결 활성 상태를 유지하고, 지휘자가 연주자의 연결 상태를 확인할 수 있도록 합니다.
*   **발신자:** 연주자 (클라이언트)
*   **수신자:** 지휘자 (서버)

```json
{
  "action": "heartbeat",
  "timestamp": <유닉스_타임스탬프_밀리초>
}
```

### 3.3 동기화 요청 (`request_sync`)

연주자가 현재 지휘자의 상태(현재 파일 및 페이지)를 요청합니다. 주로 연결 직후 또는 동기화가 필요한 상황에서 사용됩니다.

*   **목적:** 지휘자의 현재 상태를 받아 자신의 뷰어를 동기화합니다.
*   **발신자:** 연주자 (클라이언트)
*   **수신자:** 지휘자 (서버)

```json
{
  "action": "request_sync",
  "timestamp": <유닉스_타임스탬프_밀리초>
}
```

## 4. UDP 브로드캐스트 프로토콜 (자동 발견)

지휘자 기기는 UDP 브로드캐스트를 통해 자신의 존재를 알립니다. 이 메시지는 WebSocket 통신과는 별개입니다.

*   **목적:** 연주자 기기가 지휘자 기기의 IP 주소를 모르더라도 자동으로 발견할 수 있도록 합니다.
*   **발신자:** 지휘자
*   **수신자:** 로컬 네트워크 내의 모든 연주자
*   **포트:** 기본 9091

```json
{
  "name": "<문자열_지휘자_기기_이름>", // 지휘자 기기의 사용자 친화적인 이름
  "ipAddress": "<문자열_지휘자_IP_주소>", // 지휘자 기기의 로컬 IP 주소
  "port": <정수_WebSocket_포트_번호> // 지휘자 WebSocket 서버 포트 (기본 9090)
}
```
