# 3. 기능 심층 분석: 합주 모드

## 3.1 합주 모드 개요

합주 모드는 MrgqPdfViewer의 핵심 기능으로, 여러 기기 간에 PDF 악보 페이지를 실시간으로 동기화하여 합주 연습을 효율적으로 지원합니다. 지휘자(Conductor) 역할을 하는 기기가 페이지 넘김과 파일 변경을 제어하면, 연주자(Performer) 역할을 하는 기기들이 이를 실시간으로 따라갑니다.

### 주요 목표:
*   **실시간 동기화:** 지휘자의 페이지 변경 및 파일 전환에 연주자들이 즉시 반응합니다.
*   **자동 발견:** 연주자들이 네트워크에서 지휘자를 쉽게 찾고 연결할 수 있습니다.
*   **안정성:** 포트 충돌 없이 안정적인 연결을 유지하고, 예외 상황에서도 빠르게 복구됩니다.
*   **파일 공유:** 연주자에게 없는 악보 파일은 지휘자로부터 다운로드할 수 있도록 지원합니다.

## 3.2 주요 기술 과제 및 해결 과정

합주 모드를 구현하는 과정에서 여러 기술적 난관에 부딪혔으며, 이를 해결하기 위한 심층적인 분석과 아키텍처 재구조화가 이루어졌습니다.

### 3.2.1 포트 바인딩 문제 및 해결

**문제 현상:**
앱을 강제 종료하거나 재시작할 때, WebSocket 서버(기본 포트 9090)가 이전에 사용하던 포트를 즉시 해제하지 않아 `Address already in use` 오류가 발생했습니다. 이로 인해 지휘자 모드를 재시작할 수 없거나, 재시작 시 불안정한 동작을 보였습니다.

**원인 분석:**
*   `ServerSocket`의 `close()` 메서드가 즉시 포트를 해제하지 않고, 운영체제 수준에서 일정 시간(TIME_WAIT 상태) 동안 포트를 점유하는 특성 때문입니다.
*   **`GlobalCollaborationManager` 및 `MainActivity`에서 매번 새로운 서버 인스턴스를 생성하고 포트 바인딩을 시도하면서 문제가 더욱 심화되었습니다.**
*   `Accept` 스레드가 블로킹 상태에 있을 때, 메인 스레드에서 서버를 종료하려 해도 `Accept` 스레드가 즉시 종료되지 않아 포트 해제가 지연되었습니다.
*   `SO_REUSEADDR` 옵션이 제대로 활용되지 않거나, 서버 인스턴스 정리가 불완전했습니다.

**해결 과정:**
1.  **`GlobalCollaborationManager`를 통한 인스턴스 단일화 및 관리:** 서버 인스턴스가 앱 생명주기 동안 단 하나만 존재하도록 관리하고, 불필요한 재바인딩 시도를 제거했습니다.
2.  **`ServerSocket` 타임아웃 설정:** `ServerSocket`에 1초의 `soTimeout`을 설정하여 `Accept` 스레드가 블로킹 상태에서 1초마다 깨어나 `isRunning` 플래그를 확인할 수 있도록 했습니다. 이를 통해 서버 종료 요청 시 `Accept` 스레드가 빠르게 반응하여 종료될 수 있게 했습니다.
3.  **강화된 서버 종료 로직:**
    *   클라이언트 WebSocket 연결을 먼저 정상적으로 닫습니다.
    *   `SimpleWebSocketServer`의 `shutdown()` 메서드를 호출하여 서버 소켓을 닫습니다.
    *   `Accept` 스레드에 `interrupt()`를 호출하여 블로킹 상태를 강제로 해제합니다.
    *   포트 해제를 위한 충분한 대기 시간(예: 100ms)을 부여합니다.
    *   서버 인스턴스가 완전히 종료되었는지 여러 번 확인하고, 필요한 경우 재시도합니다.
4.  **`SO_REUSEADDR` 활용:** 포트 재사용 옵션을 정확히 설정하여, TIME_WAIT 상태의 포트도 즉시 재사용할 수 있도록 했습니다.
5.  **`PdfViewerApplication`을 통한 전역 관리:** 애플리케이션 생명주기 동안 합주 모드 관련 리소스를 전역적으로 관리하고, 앱 강제 종료 시에도 모든 리소스가 안전하게 정리되도록 했습니다.

**결과:**
포트 충돌 문제가 완전히 해결되었으며, 앱 강제 종료 후에도 지휘자 모드를 즉시 재시작할 수 있게 되어 합주 모드의 안정성이 대폭 향상되었습니다.

### 3.2.2 자동 발견 (UDP 브로드캐스트)

**목표:** 연주자 기기가 지휘자 기기의 IP 주소를 모르더라도 자동으로 지휘자를 찾아 연결할 수 있도록 합니다.

**구현:**
*   **UDP 브로드캐스트:** 지휘자 기기는 특정 포트(기본 9091)로 자신의 존재를 알리는 UDP 브로드캐스트 메시지를 주기적으로 전송합니다.
*   **메시지 내용:** 지휘자 기기의 이름, IP 주소, WebSocket 서버 포트(9090) 등의 정보를 포함합니다.
*   **연주자 수신:** 연주자 기기는 동일한 포트에서 UDP 메시지를 수신 대기하며, 지휘자로부터 메시지를 받으면 해당 지휘자 정보를 파싱하여 목록에 추가합니다.
*   **최적화:**
    *   브로드캐스트 간격 및 수신 타임아웃을 최적화하여 빠른 발견과 반응성을 확보했습니다.
    *   네트워크 인터페이스 자동 감지 및 다양한 브로드캐스트 주소 전략(예: 현재 IP 기반 계산된 브로드캐스트 주소, 255.255.255.255)을 사용하여 발견 성공률을 높였습니다.

**결과:** 연주자들은 지휘자의 IP 주소를 수동으로 입력할 필요 없이, 대부분 1~2초 내에 지휘자를 자동으로 발견하고 연결할 수 있게 되었습니다.

### 3.2.3 실시간 동기화 (WebSocket)

**목표:** 지휘자와 연주자 간에 페이지 변경 및 파일 전환 정보를 실시간으로 지연 없이 전달합니다.

**구현:**
*   **WebSocket 프로토콜:** `okhttp` 라이브러리를 사용하여 WebSocket 연결을 설정합니다.
*   **JSON 메시지:** 페이지 번호, 파일 이름, 타임스탬프 등 동기화에 필요한 정보를 JSON 형식으로 주고받습니다.
*   **지휘자 브로드캐스트:** 지휘자는 페이지를 넘기거나 파일을 변경할 때, 연결된 모든 연주자에게 해당 정보를 브로드캐스트합니다.
*   **연주자 반응:** 연주자는 수신된 메시지를 파싱하여 자신의 PDF 뷰어를 즉시 업데이트합니다.
*   **전역 파일 변경 처리:** `MainActivity`와 `PdfViewerActivity` 등 어떤 화면에 있든 연주자가 지휘자의 파일 변경 신호를 수신하고 반응할 수 있도록 로직을 통합했습니다.

**결과:** 지휘자가 페이지를 넘기면 연주자 기기에서 거의 동시에 페이지가 전환되는 매끄러운 실시간 동기화 경험을 제공합니다.

### 3.2.4 보안 강화 (WSS)

**목표:** 합주 모드 통신 채널을 암호화하여 로컬 네트워크 내에서의 도청 및 중간자 공격을 방지합니다.

**구현:**
*   **WSS (WebSocket Secure) 전환:** 기존 `ws://` 프로토콜 대신 `wss://`를 사용하여 TLS(Transport Layer Security) 암호화를 적용합니다.
*   **Self-Signed 인증서:** 앱 내부에 미리 생성된 self-signed 인증서(`keystore.bks`)와 공개키(`mycert.crt`)를 내장합니다.
*   **인증서 피닝 (Certificate Pinning):**
    *   지휘자 앱은 내장된 `keystore.bks`를 사용하여 WSS 서버를 구동합니다.
    *   연주자 앱은 `network_security_config.xml`을 통해 내장된 `mycert.crt`를 신뢰하도록 설정됩니다. 이는 해당 인증서가 아니면 연결을 거부하여 중간자 공격을 방지합니다.
*   **우아한 폴백:** SSL 설정에 문제가 발생할 경우, 기존 WS 프로토콜로 자동 전환하는 메커니즘을 고려하여 안정성을 확보합니다.

**결과:** 합주 모드 통신은 이제 암호화되어 보안이 강화되었으며, 로컬 네트워크 환경에서도 안전하게 데이터를 주고받을 수 있습니다.

## 3.3 최종 구현 상태

현재 합주 모드는 다음과 같은 아키텍처와 기능을 통해 안정적으로 작동하고 있습니다.

*   **지휘자 모드:**
    *   `CollaborationServerManager`가 `SimpleWebSocketServer`를 통해 WSS 서버를 구동합니다.
    *   `ConductorDiscovery`가 UDP 브로드캐스트를 통해 자신의 존재를 알립니다.
    *   `FileServerManager`가 HTTP 파일 서버를 구동하여 연주자에게 파일을 제공합니다.
    *   `GlobalCollaborationManager`를 통해 페이지 변경 및 파일 변경을 모든 연주자에게 브로드캐스트합니다.
*   **연주자 모드:**
    *   `ConductorDiscovery`를 통해 네트워크에서 지휘자를 자동으로 검색합니다.
    *   `CollaborationClientManager`가 발견된 지휘자에게 WSS로 연결합니다.
    *   지휘자로부터 수신된 페이지/파일 변경 메시지를 파싱하여 자신의 뷰어를 업데이트합니다.
    *   필요시 지휘자의 파일 서버로부터 악보 파일을 다운로드합니다.
*   **전역 관리:** `GlobalCollaborationManager`는 앱의 생명주기와 관계없이 합주 모드의 상태를 유지하고, 각 컴포넌트 간의 조정을 담당합니다.
*   **UI 피드백:** `MainActivity`와 `PdfViewerActivity`는 합주 모드의 현재 상태(연결 여부, 연결된 연주자 수 등)를 사용자에게 실시간으로 표시합니다.

이러한 통합된 접근 방식을 통해 MrgqPdfViewer의 합주 모드는 강력하고 안정적인 실시간 악보 동기화 기능을 제공합니다.
