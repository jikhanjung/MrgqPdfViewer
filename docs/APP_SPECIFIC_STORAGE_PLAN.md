# 앱 전용 디렉토리 기반 스토리지 개선 계획 (최종안)

## 1. 개요

이 문서는 `STORAGE_IMPROVEMENT_PLAN.md`에 대한 검토 후, Storage Access Framework(SAF)를 사용하지 않고 **앱 전용 디렉토리만**을 사용하여 저장소 문제를 해결하는, 더 단순화된 최종 계획을 정의합니다.

이 접근 방식은 앱의 복잡성을 줄이고, 사용자에게 명확한 파일 관리 모델을 제공하는 데 중점을 둡니다.

## 2. 새로운 접근 방식: 단일 소스 관리

*   **파일 저장소 단일화:** 앞으로 모든 PDF 파일은 앱의 웹 업로드 기능을 통해서만 추가되며, `context.getExternalFilesDir()`가 반환하는 앱 전용 디렉토리에만 저장됩니다. 이 디렉토리에 있는 파일만 앱 내 목록에 표시됩니다.
*   **권한 요구 제로:** 이 방식은 런타임에 사용자에게 어떤 저장소 관련 권한도 요구하지 않으므로, 권한 팝업과 설정 메뉴 이동의 필요성이 완전히 사라집니다.
*   **사용자 제어:** 사용자는 웹 인터페이스를 통해 자신의 PDF 라이브러리를 명시적으로 제어하게 됩니다. 외부 폴더를 스캔하는 방식은 완전히 배제됩니다.

## 3. 단계별 구현 계획

### 1단계: 웹 서버 저장 위치 및 파일 로딩 로직 변경

*   **1.1 `WebServerManager.kt` 수정:**
    *   파일을 저장하는 로직에서 현재의 공용 `Download` 폴더 경로 대신, `context.getExternalFilesDir(Environment.DIRECTORY_DOCUMENTS)` 또는 유사한 앱 전용 경로에 파일을 저장하도록 수정합니다. 이 경로는 별도의 권한 없이 항상 읽고 쓸 수 있습니다.

*   **1.2 `MainActivity.kt`의 `getCurrentPdfFiles()` 수정:**
    *   기존의 공용 `Download` 폴더를 스캔하는 모든 코드를 제거합니다.
    *   오직 1.1에서 지정한 **앱 전용 디렉토리**만을 스캔하여 파일 목록을 가져오도록 로직을 대폭 단순화합니다.

### 2단계: 레거시 권한 및 관련 코드 완전 제거

*   **2.1 `AndroidManifest.xml` 수정:**
    *   `<uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" />` 권한 선언을 완전히 삭제합니다.
    *   하위 호환성을 위해 남아있던 `READ_EXTERNAL_STORAGE`, `WRITE_EXTERNAL_STORAGE` 권한 선언도 함께 삭제합니다.

*   **2.2 `MainActivity.kt` 코드 정리:**
    *   `checkPermissions()`, `onRequestPermissionsResult()`, `onActivityResult()` 등 `MANAGE_EXTERNAL_STORAGE` 권한 획득과 관련된 모든 메서드와 호출 코드를 삭제합니다.

### 3단계: 사용자 안내 및 데이터 전환

*   **3.1 사용자 안내 UI 구현:**
    *   앱 업데이트 후 첫 실행 시, 기존 사용자에게 저장소 정책 변경을 알리는 다이얼로그를 한 번만 표시합니다.
    *   **안내 메시지 예시:** "개인정보 보호 강화를 위해 파일 관리 방식이 변경되었습니다. 기존에 사용하시던 PDF 파일들은 앱의 웹 업로드 기능을 통해 다시 추가해주시기 바랍니다."

*   **3.2 웹 인터페이스 문구 수정:**
    *   웹 업로드 페이지의 안내 문구를 "업로드된 파일은 앱의 안전한 내부 저장소에 보관됩니다." 와 같이 명확하게 변경합니다.

## 4. 데이터 마이그레이션 계획 (중요)

*   **자동 마이그레이션 없음:** 새로운 정책 하에서는 앱이 더 이상 기존의 공용 폴더 경로에 접근할 수 없으므로, 파일을 자동으로 새 위치로 옮기는 것은 불가능합니다.
*   **데이터베이스 초기화:** 앱 업데이트 시, 기존의 `PdfFile` 테이블에 저장된 모든 데이터를 삭제하는 것을 권장합니다. 이는 더 이상 유효하지 않은 파일 경로를 참조하여 발생할 수 있는 오류를 원천적으로 차단하는 가장 깔끔한 방법입니다.
*   **사용자 재업로드:** 사용자는 웹 업로드 기능을 통해 자신의 악보 라이브러리를 다시 구축해야 합니다. 이는 다소 불편할 수 있으나, 장기적으로 훨씬 더 안정적이고 안전한 환경을 제공합니다.

## 5. 기대 효과

*   **최고 수준의 보안:** 앱이 꼭 필요한 자신의 디렉토리에만 접근하므로, 사용자의 다른 파일에 대한 접근이 원천적으로 차단됩니다.
*   **최상의 사용자 경험:** 앱 설치 후 어떤 권한도 요구하지 않아 즉시 사용 가능하며, 복잡한 권한 설정 과정이 없습니다.
*   **Google Play 정책 완벽 준수:** 민감한 `MANAGE_EXTERNAL_STORAGE` 권한을 사용하지 않아, 향후 정책 변경에 대한 걱정 없이 앱을 배포하고 업데이트할 수 있습니다.
*   **코드베이스 단순화:** 저장소 관련 로직이 매우 단순해져 유지보수가 용이해집니다.
