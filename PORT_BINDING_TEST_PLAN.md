# 🧪 포트 바인딩 문제 테스트 계획

## 📋 테스트 목표
SimpleWebSocketServer의 소켓 타임아웃 구현이 포트 바인딩 문제를 해결하는지 검증

## 🎯 예상 결과
- **이전**: 앱 강제 종료 후 포트 9090이 계속 점유되어 재활성화 불가
- **현재**: 1초 내에 포트 해제되어 즉시 재활성화 가능

## 📱 테스트 환경
- **기기**: Z18TV Pro (Android TV)
- **포트**: 9090 (WebSocket), 9091 (Discovery), 8090 (FileServer)
- **네트워크**: 같은 Wi-Fi 네트워크

## 🧪 테스트 시나리오

### 테스트 1: 정상 종료 시나리오
1. 앱 실행
2. 설정 → 협업 모드 → 지휘자 모드 활성화
3. 지휘자 모드 비활성화
4. 다시 지휘자 모드 활성화
5. **예상 결과**: 즉시 성공

### 테스트 2: 강제 종료 시나리오 (핵심)
1. 앱 실행
2. 설정 → 협업 모드 → 지휘자 모드 활성화
3. Recent Apps에서 앱 스와이프하여 강제 종료
4. 1-2초 대기
5. 앱 재시작
6. 설정 → 협업 모드 → 지휘자 모드 활성화
7. **예상 결과**: 성공 (이전에는 "Address already in use" 에러)

### 테스트 3: 연속 강제 종료 시나리오
1. 테스트 2를 3회 연속 반복
2. **예상 결과**: 매번 성공

### 테스트 4: 연주자 연결 중 강제 종료
1. 지휘자 모드 활성화
2. 다른 기기에서 연주자 모드로 연결
3. 지휘자 앱 강제 종료
4. 지휘자 앱 재시작 후 지휘자 모드 재활성화
5. **예상 결과**: 성공

### 테스트 5: ADB 강제 종료 시나리오
```bash
# Windows에서 실행
adb shell am force-stop com.mrgq.pdfviewer
```
1. 지휘자 모드 활성화
2. 위 명령으로 강제 종료
3. 앱 재시작 후 지휘자 모드 재활성화
4. **예상 결과**: 성공

## 🔍 디버깅 방법

### 로그 확인
```bash
# 포트 바인딩 관련 로그 필터링
adb logcat | grep -E "SimpleWebSocketServer|CollaborationServerManager|port|9090"
```

### 주요 확인 로그
- "Server socket timeout set to 1000ms" - 타임아웃 설정 확인
- "Accept timeout - checking shutdown signal..." - 타임아웃 동작 확인
- "Accept thread terminated gracefully" - 정상 종료 확인
- "WebSocket server shutdown complete" - 완전 종료 확인

### 포트 상태 확인 (선택적)
```bash
# Android 기기에서 포트 사용 확인
adb shell netstat -an | grep 9090
```

## 📊 성공 기준
- **즉시성**: 앱 강제 종료 후 1-2초 내에 포트 재사용 가능
- **안정성**: 10회 테스트 중 9회 이상 성공
- **일관성**: 다양한 종료 시나리오에서 동일하게 동작

## 🚨 실패 시 추가 확인 사항
1. **로그 분석**
   - Accept 스레드가 정상 종료되었는지 확인
   - SocketTimeoutException이 발생하는지 확인
   
2. **타이밍 조정 검토**
   - soTimeout 값 조정 (현재 1000ms)
   - shutdown 대기 시간 조정 (현재 500ms)

3. **추가 해결책 적용**
   - SO_LINGER(0) 설정 추가
   - NIO 기반 구현으로 전환
   - 동적 포트 할당 시스템

## 📝 테스트 결과 기록

### 테스트 실행 일시: _____________

### 테스트 결과
| 시나리오 | 결과 | 비고 |
|---------|------|------|
| 테스트 1 | [ ] 성공 [ ] 실패 | |
| 테스트 2 | [ ] 성공 [ ] 실패 | |
| 테스트 3 | [ ] 성공 [ ] 실패 | |
| 테스트 4 | [ ] 성공 [ ] 실패 | |
| 테스트 5 | [ ] 성공 [ ] 실패 | |

### 관찰된 문제점
- 

### 개선 필요 사항
- 

## 🎯 다음 단계
1. **성공 시**: 문서 업데이트 및 배포 준비
2. **부분 성공 시**: 타이밍 값 조정 후 재테스트
3. **실패 시**: PORT_BINDING_ISSUE.md의 고급 해결 방안 적용